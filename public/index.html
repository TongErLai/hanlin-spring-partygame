<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spring Party Game</title>
    <!-- 引入 Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 自訂樣式 -->
    <style>
        body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
    }

    /* 自訂導覽列樣式 */
    .navbar-custom {
      background-color: #343a40; /* 深灰色背景 */
      color: white;
    }

    .navbar-custom .nav-link {
      color: white;
    }

    .navbar-custom .nav-link:hover {
      color: #ffc107; /* 金黃色 */
    }

    .container {
      max-width: 600px;
      margin: 20px auto;
      text-align: center;
    }

    .error-message {
      color: red;
      margin-top: 0.5rem;
    }

    .d-none {
      display: none !important;
    }

    /* 加載中畫面樣式 */
    #loading-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-size: 1.5rem;
      background-color: #f9f9f9;
    }
  </style>
</head>

<body>
    <!-- 加載中畫面 -->
    <div id="loading-screen">正在加載，請稍候...</div>
      <!-- 導覽列 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">春酒遊戲</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
          data-bs-target="#navbarNav" aria-controls="navbarNav"
          aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav mx-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">首頁</a></li>
            <li class="nav-item"><a class="nav-link" href="game1.html">六六大順</a></li>
            <li class="nav-item"><a class="nav-link" href="game2.html">新春貪食蛇</a></li>
            <li class="nav-item"><a class="nav-link" href="game3.html">投你所號</a></li>
            <li class="nav-item"><a class="nav-link" href="prizes.html">獎品兌換</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- 主內容 -->
    <main class="container d-none" id="main-content">
        <!-- 登入表單 -->
        <section id="login-section">
            <h2>登入</h2>
            <form id="login-form">
                <div class="mb-3 text-start">
                    <label for="email" class="form-label">Email:</label>
                    <input type="email" id="email" class="form-control" placeholder="輸入你的公司 Email" required />
                </div>
                <div class="mb-3 text-start">
                    <label for="password" class="form-label">密碼:</label>
                    <input type="password" id="password" class="form-control" placeholder="輸入你的密碼" required />
                </div>
                <button type="submit" class="btn btn-primary w-100">登入</button>
            </form>
            <p id="login-error" class="error-message d-none">登入失敗，請檢查帳號或密碼。</p>
        </section>
        <!-- 活動規則 -->
        <section id="rules-section" class="d-none mt-4">
            <h2>活動規則</h2>
            <p id="auth-status">歡迎，</p>
            <button id="logout-btn" class="btn btn-danger w-100">登出</button>
        </section>
    </main>
    <!-- Firebase JS -->
    <script type="module">
        import { auth, rtdb } from "./js/firebase.js";
    import {
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
    import { ref, get } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const navbar = document.getElementById("navbar");
    const mainContent = document.getElementById("main-content");
    const loadingScreen = document.getElementById("loading-screen");
    const loginSection = document.getElementById("login-section");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const rulesSection = document.getElementById("rules-section");
    const logoutBtn = document.getElementById("logout-btn");
    const authStatus = document.getElementById("auth-status");

    // 當頁面加載完成後
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        // 嘗試檢查登入狀態
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            loginSection.classList.add("d-none");
            navbar.classList.remove("d-none");
            rulesSection.classList.remove("d-none");

            // 嘗試從 Real-time Database 讀取名稱
            const userRef = ref(rtdb, `users/${user.uid}`);
            get(userRef)
              .then((snapshot) => {
                if (snapshot.exists()) {
                  const userName = snapshot.val().name || "使用者";
                  authStatus.textContent = `歡迎，${userName}`;
                } else {
                  authStatus.textContent = "歡迎，使用者 (未找到資料)";
                  console.warn("資料庫中未找到使用者資料");
                }
              })
              .catch((error) => {
                console.error("讀取 Real-time Database 失敗:", error.message);
                authStatus.textContent = "歡迎，使用者 (讀取失敗)";
              });
          } else {
            loginSection.classList.remove("d-none");
            navbar.classList.add("d-none");
            rulesSection.classList.add("d-none");
            authStatus.textContent = "";
          }

          // 隱藏加載中畫面，顯示主內容
          loadingScreen.style.display = "none";
          mainContent.classList.remove("d-none");
        });
      } catch (error) {
        console.error("初始化失敗：", error.message);
        alert("初始化失敗，請稍候再試！");
      }
    });

    // 登入行為
    loginForm.addEventListener("submit", (event) => {
      event.preventDefault();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          console.log("登入成功");
          loginError.classList.add("d-none");
        })
        .catch((error) => {
          console.error("登入失敗:", error.message);
          loginError.textContent = `登入失敗: ${error.message}`;
          loginError.classList.remove("d-none");
        });
    });

    // 登出行為
    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => console.log("登出成功"));
    });
  </script>
</body>

</html>